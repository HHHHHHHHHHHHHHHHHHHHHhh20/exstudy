<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DaiPæ™ºèƒ½èŠå¤©å®¤</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        /* èŠå¤©å®¤æ•´ä½“å¸ƒå±€ */
        .chat-container {
            display: flex;
            height: 100vh;
            background-color: #f5f5f5;
        }
        
        /* ä¾§è¾¹æ  - ç”¨æˆ·åˆ—è¡¨ */
        .sidebar {
            width: 280px;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #34495e;
        }
        
        .sidebar-header h2 {
            margin: 0;
            font-size: 20px;
        }
        
        .user-count {
            font-size: 14px;
            color: #bdc3c7;
            margin-top: 5px;
        }
        
        .user-list {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }
        
        .user-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background-color: #34495e;
            border-radius: 8px;
            transition: background-color 0.3s;
        }
        
        .user-item:hover {
            background-color: #3c5a73;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            background-color: #4CAF50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
        }
        
        .user-name {
            flex: 1;
            font-size: 14px;
        }
        
        .self-indicator {
            font-size: 12px;
            color: #bdc3c7;
            font-style: italic;
        }
        
        /* ä¸»èŠå¤©åŒºåŸŸ */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
        }
        
        .chat-header {
            padding: 15px 20px;
            background-color: #ffffff;
            border-bottom: 1px solid #e1e1e1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .chat-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .exit-button {
            padding: 8px 16px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 14px;
        }
        
        .exit-button:hover {
            background-color: #d32f2f;
        }
        
        /* æ¶ˆæ¯åŒºåŸŸ */
        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #fafafa;
        }
        
        .message {n            margin-bottom: 20px;
            max-width: 70%;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.self {
            margin-left: auto;
        }
        
        .message-info {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .message-user {
            font-weight: bold;
            font-size: 14px;
            margin-right: 10px;
        }
        
        .message.self .message-user {
            color: #4CAF50;
        }
        
        .message-time {
            font-size: 12px;
            color: #999;
        }
        
        .message-content {
            background-color: #f1f1f1;
            padding: 12px 16px;
            border-radius: 12px;
            word-wrap: break-word;
            line-height: 1.5;
        }
        
        .message.self .message-content {
            background-color: #4CAF50;
            color: white;
        }
        
        /* AIåŠ©æ‰‹æ¶ˆæ¯æ ·å¼ */
        .ai-message {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid #2196F3;
        }
        
        .ai-message .ai-name {
            font-weight: bold;
            color: #1976D2;
            margin-bottom: 8px;
        }
        
        .ai-message .ai-content {
            color: #333;
            line-height: 1.5;
        }
        
        /* ç³»ç»Ÿæ¶ˆæ¯æ ·å¼ */
        .system-message {
            text-align: center;
            margin: 15px 0;
        }
        
        .system-message span {
            background-color: #e0e0e0;
            color: #666;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 13px;
        }
        
        /* ç”µå½±æ’­æ”¾å™¨æ ·å¼ */
        .movie-container {
            background-color: #000;
            border-radius: 12px;
            margin: 20px 0;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .movie-header {
            background-color: #2c3e50;
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .movie-title {
            font-weight: bold;
        }
        
        .movie-controls button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            margin-left: 10px;
            font-size: 16px;
        }
        
        .movie-player {
            width: 100%;
            min-height: 400px;
            border: none;
        }
        
        /* è¾“å…¥åŒºåŸŸ */
        .input-area {
            padding: 20px;
            background-color: #ffffff;
            border-top: 1px solid #e1e1e1;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .input-container {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }
        
        #message-input {
            flex: 1;
            min-height: 40px;
            max-height: 120px;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            resize: none;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        
        #message-input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        .send-button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .send-button:hover {
            background-color: #45a049;
        }
        
        .send-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .message {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- ä¾§è¾¹æ  - ç”¨æˆ·åˆ—è¡¨ -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>åœ¨çº¿ç”¨æˆ·</h2>
                <div class="user-count" id="user-count">0 äººåœ¨çº¿</div>
            </div>
            <div class="user-list" id="user-list">
                <!-- ç”¨æˆ·åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
            </div>
        </div>
        
        <!-- ä¸»èŠå¤©åŒºåŸŸ -->
        <div class="chat-main">
            <div class="chat-header">
                <div class="chat-title">DaiPæ™ºèƒ½èŠå¤©å®¤</div>
                <button id="exit-button" class="exit-button">é€€å‡º</button>
            </div>
            
            <div class="messages-container" id="messages-container">
                <!-- æ¶ˆæ¯å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                <div class="system-message"><span>æ¬¢è¿æ¥åˆ°DaiPæ™ºèƒ½èŠå¤©å®¤ï¼</span></div>
            </div>
            
            <div class="input-area">
                <div class="input-container">
                    <textarea id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯... æ”¯æŒ@ç”µå½±å’Œ@å·å°å†œæŒ‡ä»¤"></textarea>
                    <button id="send-button" class="send-button">å‘é€</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // è·å–é¡µé¢å…ƒç´ 
            const messagesContainer = document.getElementById('messages-container');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const exitButton = document.getElementById('exit-button');
            const userList = document.getElementById('user-list');
            const userCount = document.getElementById('user-count');
            
            // ä»URLè·å–ç”¨æˆ·åå’ŒæœåŠ¡å™¨åœ°å€
            const urlParams = new URLSearchParams(window.location.search);
            const username = urlParams.get('username');
            const server = urlParams.get('server');
            
            // è¿æ¥WebSocketæœåŠ¡å™¨
            const socket = io();
            
            // å‘é€åŠ å…¥æˆ¿é—´äº‹ä»¶
            socket.emit('join', { username: username, server: server });
            
            // è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬åŸŸé«˜åº¦
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight < 120 ? this.scrollHeight : 120) + 'px';
            });
            
            // å‘é€æ¶ˆæ¯
            function sendMessage() {
                const message = messageInput.value.trim();
                if (message === '') return;
                
                const now = new Date();
                const timestamp = now.toLocaleTimeString('zh-CN', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                // å‘é€æ¶ˆæ¯äº‹ä»¶
                socket.emit('send_message', {
                    username: username,
                    message: message,
                    timestamp: timestamp
                });
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                messageInput.value = '';
                messageInput.style.height = 'auto';
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯@å·å°å†œæŒ‡ä»¤ï¼Œå¦‚æœæ˜¯ï¼Œè‡ªåŠ¨å¼¹å‡ºAIè‡ªæˆ‘ä»‹ç»
                if (message.startsWith('@å·å°å†œ')) {
                    setTimeout(() => {
                        showAiIntroduction();
                    }, 1000);
                }
            }
            
            // å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            sendButton.addEventListener('click', sendMessage);
            
            // æŒ‰Enteré”®å‘é€æ¶ˆæ¯ï¼ˆShift+Enteræ¢è¡Œï¼‰
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // é€€å‡ºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            exitButton.addEventListener('click', function() {
                socket.emit('leave');
                window.location.href = '/';
            });
            
            // æ˜¾ç¤ºAIåŠ©æ‰‹è‡ªæˆ‘ä»‹ç»
            function showAiIntroduction() {
                const aiIntro = document.createElement('div');
                aiIntro.className = 'ai-message';
                aiIntro.innerHTML = `
                    <div class="ai-name">å·å°å†œ</div>
                    <div class="ai-content">
                        ä½ å¥½ï¼æˆ‘æ˜¯å››å·å†œä¸šå¤§å­¦çš„AIå°åŠ©æ‰‹å·å°å†œã€‚æˆ‘å¯ä»¥å›ç­”å…³äºå››å·å†œä¸šå¤§å­¦çš„é—®é¢˜ï¼Œä¸ºä½ åˆ›ä½œä¸ƒè¨€å¤è¯—ï¼Œè¿˜èƒ½ç”Ÿæˆå­¦æ ¡é€šçŸ¥æ ¼å¼ã€‚æœ‰ä»€ä¹ˆå¯ä»¥å¸®åˆ°ä½ çš„å—ï¼Ÿ
                    </div>
                `;
                messagesContainer.appendChild(aiIntro);
                scrollToBottom();
            }
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            function scrollToBottom() {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            // æ˜¾ç¤ºæ¶ˆæ¯
            function displayMessage(data, isSelf = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isSelf ? 'self' : ''}`;
                
                const messageInfo = document.createElement('div');
                messageInfo.className = 'message-info';
                messageInfo.innerHTML = `
                    <span class="message-user">${data.username}</span>
                    <span class="message-time">${data.timestamp}</span>
                `;
                
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                
                // å¤„ç†@ç”¨æˆ·é«˜äº®
                let content = data.message;
                if (content.includes('@')) {
                    content = content.replace(/@(\S+)/g, '<span style="color: #4CAF50; font-weight: bold;">@$1</span>');
                }
                
                messageContent.innerHTML = content;
                
                messageDiv.appendChild(messageInfo);
                messageDiv.appendChild(messageContent);
                
                messagesContainer.appendChild(messageDiv);
                scrollToBottom();
            }
            
            // æ˜¾ç¤ºAIå›å¤
            function displayAiResponse(data) {
                const aiMessage = document.createElement('div');
                aiMessage.className = 'ai-message';
                aiMessage.innerHTML = `
                    <div class="ai-name">${data.assistant}</div>
                    <div class="ai-content">${data.response}</div>
                `;
                messagesContainer.appendChild(aiMessage);
                scrollToBottom();
            }
            
            // æ˜¾ç¤ºç”µå½±æ’­æ”¾å™¨
            function displayMoviePlayer(data) {
                const movieContainer = document.createElement('div');
                movieContainer.className = 'movie-container';
                movieContainer.innerHTML = `
                    <div class="movie-header">
                        <div class="movie-title">ğŸ“º ${data.username} æ’­æ”¾ç”µå½±: ${data.movie_name}</div>
                        <div class="movie-controls">
                            <button onclick="this.closest('.movie-container').remove()">âœ•</button>
                        </div>
                    </div>
                    <iframe class="movie-player" src="${data.movie_url}" allowfullscreen></iframe>
                `;
                messagesContainer.appendChild(movieContainer);
                scrollToBottom();
            }
            
            // æ›´æ–°ç”¨æˆ·åˆ—è¡¨
            function updateUserList(users) {
                userList.innerHTML = '';
                userCount.textContent = `${users.length} äººåœ¨çº¿`;
                
                users.forEach(user => {
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';
                    
                    const avatarText = user.charAt(0).toUpperCase();
                    const isSelf = user === username;
                    
                    userItem.innerHTML = `
                        <div class="user-avatar">${avatarText}</div>
                        <div class="user-name">${user}</div>
                        ${isSelf ? '<div class="self-indicator">æˆ‘</div>' : ''}
                    `;
                    
                    userList.appendChild(userItem);
                });
            }
            
            // æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯
            function displaySystemMessage(message) {
                const systemMessage = document.createElement('div');
                systemMessage.className = 'system-message';
                systemMessage.innerHTML = `<span>${message}</span>`;
                messagesContainer.appendChild(systemMessage);
                scrollToBottom();
            }
            
            // WebSocketäº‹ä»¶ç›‘å¬
            
            // è¿æ¥æˆåŠŸ
            socket.on('connect', function() {
                console.log('å·²è¿æ¥åˆ°æœåŠ¡å™¨');
            });
            
            // è¿æ¥æ–­å¼€
            socket.on('disconnect', function() {
                console.log('ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥');
                displaySystemMessage('ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            });
            
            // åŠ å…¥æˆåŠŸ
            socket.on('join_success', function(data) {
                displaySystemMessage(data.message);
                updateUserList(data.online_users);
            });
            
            // æ–°ç”¨æˆ·åŠ å…¥
            socket.on('user_joined', function(data) {
                displaySystemMessage(data.message);
                updateUserList(data.online_users);
            });
            
            // ç”¨æˆ·ç¦»å¼€
            socket.on('user_left', function(data) {
                displaySystemMessage(`${data.username} ç¦»å¼€äº†èŠå¤©å®¤`);
                updateUserList(data.online_users);
            });
            
            // æ–°æ¶ˆæ¯
            socket.on('new_message', function(data) {
                const isSelf = data.username === username;
                displayMessage(data, isSelf);
                
                // å¦‚æœæ˜¯@å½“å‰ç”¨æˆ·ï¼Œæ˜¾ç¤ºé€šçŸ¥
                if (data.at_user && data.at_user === username && !isSelf) {
                    if (Notification.permission === 'granted') {
                        new Notification('æœ‰äºº@ä½ ', {
                            body: `${data.username}: ${data.message}`,
                            icon: '/static/images/notification-icon.png'
                        });
                    } else if (Notification.permission !== 'denied') {
                        Notification.requestPermission();
                    }
                }
            });
            
            // AIå›å¤
            socket.on('ai_response', function(data) {
                displayAiResponse(data);
            });
            
            // ç”µå½±æ’­æ”¾
            socket.on('movie_play', function(data) {
                displayMoviePlayer(data);
            });
            
            // è¯·æ±‚é€šçŸ¥æƒé™
            if ("Notification" in window) {
                Notification.requestPermission();
            }
            
            // é¡µé¢å…³é—­æ—¶æ–­å¼€è¿æ¥
            window.addEventListener('beforeunload', function() {
                socket.emit('leave');
            });
        });
    </script>
</body>
</html>